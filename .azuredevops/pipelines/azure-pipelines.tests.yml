trigger:
  branches:
    include:
      - main
      - develop
      - feature/*
      - bugfix/*

pr:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: 'windows-latest'

variables:
  - name: PesterMinVersion
    value: '5.0'

stages:
  - stage: Test
    displayName: 'Run Pester Tests'
    jobs:
      - job: UnitTests
        displayName: 'Unit Tests'
        steps:
          - checkout: self
            displayName: 'Checkout repository'

          - pwsh: |
              Write-Host "##[group]Install Pester Module"
              Write-Verbose "Installing Pester module version $(PesterMinVersion) or higher"
              Install-Module -Name Pester -MinimumVersion $(PesterMinVersion) -Force -AllowClobber -Scope CurrentUser -SkipPublisherCheck
              Write-Host "##[endgroup]"
            displayName: 'Install Pester'
            errorActionPreference: Stop

          - pwsh: |
              Write-Host "##[group]Run Pester Tests"
              Write-Verbose "Executing Pester tests (excluding Integration tests)"

              $pesterParams = @{
                  Path         = './Tests'
                  ExcludeTag   = 'Integration'
                  OutputFormat = 'NUnitXml'
                  OutputFile   = 'TestResults.xml'
                  PassThru     = $true
                  CI           = $true
              }

              $testResults = Invoke-Pester @pesterParams

              Write-Host "##[section]Test Results Summary"
              Write-Host "  Total Tests: $($testResults.TotalCount)"
              Write-Host "  Passed: $($testResults.PassedCount)"
              Write-Host "  Failed: $($testResults.FailedCount)"
              Write-Host "  Skipped: $($testResults.SkippedCount)"
              Write-Host "##[endgroup]"

              if ($testResults.FailedCount -gt 0) {
                  Write-Host "##[error]Tests failed with $($testResults.FailedCount) failure(s)"
                  exit 1
              }
            displayName: 'Run Unit Tests'
            errorActionPreference: Stop

          - task: PublishTestResults@2
            displayName: 'Publish Test Results'
            condition: always()
            inputs:
              testResultsFormat: 'NUnit'
              testResultsFiles: 'TestResults.xml'
              failTaskOnFailedTests: true
              testRunTitle: 'Pester Unit Tests'
              publishRunAttachments: true

      - job: IntegrationTests
        displayName: 'Integration Tests (Manual)'
        condition: false  # Manual trigger only
        steps:
          - checkout: self
            displayName: 'Checkout repository'

          - pwsh: |
              Write-Host "##[group]Install Pester Module"
              Write-Verbose "Installing Pester module version $(PesterMinVersion) or higher"
              Install-Module -Name Pester -MinimumVersion $(PesterMinVersion) -Force -AllowClobber -Scope CurrentUser -SkipPublisherCheck
              Write-Host "##[endgroup]"
            displayName: 'Install Pester'
            errorActionPreference: Stop

          - pwsh: |
              Write-Host "##[group]Run Integration Tests"
              Write-Verbose "Executing Pester integration tests"

              $pesterParams = @{
                  Path         = './Tests'
                  Tag          = 'Integration'
                  OutputFormat = 'NUnitXml'
                  OutputFile   = 'IntegrationTestResults.xml'
                  PassThru     = $true
                  CI           = $true
              }

              $testResults = Invoke-Pester @pesterParams

              Write-Host "##[section]Integration Test Results Summary"
              Write-Host "  Total Tests: $($testResults.TotalCount)"
              Write-Host "  Passed: $($testResults.PassedCount)"
              Write-Host "  Failed: $($testResults.FailedCount)"
              Write-Host "  Skipped: $($testResults.SkippedCount)"
              Write-Host "##[endgroup]"

              if ($testResults.FailedCount -gt 0) {
                  Write-Host "##[error]Integration tests failed with $($testResults.FailedCount) failure(s)"
                  exit 1
              }
            displayName: 'Run Integration Tests'
            errorActionPreference: Stop
            env:
              AZURE_DEVOPS_ORGANIZATION: $(AZURE_DEVOPS_ORGANIZATION)
              AZURE_TENANT_ID: $(AZURE_TENANT_ID)
              AZURE_CLIENT_ID: $(AZURE_CLIENT_ID)
              AZURE_CLIENT_SECRET: $(AZURE_CLIENT_SECRET)

          - task: PublishTestResults@2
            displayName: 'Publish Integration Test Results'
            condition: always()
            inputs:
              testResultsFormat: 'NUnit'
              testResultsFiles: 'IntegrationTestResults.xml'
              failTaskOnFailedTests: true
              testRunTitle: 'Pester Integration Tests'
              publishRunAttachments: true
